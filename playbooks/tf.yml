- name: Ejecutar Terraform desde Ansible
  hosts: localhost
  gather_facts: false

  vars:
    tf_dir: "./terraform/odoo"
    tf_host: "dv-addonstest"



  tasks:
    - name: Comprobar que terraform existe
      ansible.builtin.command: terraform version
      register: tf_version
      changed_when: false

    - name: Generar archivo de credentials
      ansible.builtin.copy:
        content: "{{ tf_credentials_content }}"
        dest: "{{ tf_dir }}/credentials.json"
        mode: '0600'

    - name: Generar archivo de configuraciÃ³n
      ansible.builtin.copy:
        content: |
          hostname = {{ tf_host }}
          subdomain = "addonstest"
        dest: "{{ tf_dir }}/credentials.auto.tfvars"
        mode: '0644'

    - name: Terraform init
      ansible.builtin.command: >
        terraform init -input=false
        {% if tf_reconfigure %}-reconfigure{% endif %}
        -backend-config="key=netbox/{{ tf_host }}/terraform.tfstate"
      args:
        chdir: "{{ tf_dir }}"

    - name: Terraform plan (opcional pero recomendado)
      ansible.builtin.command: >
        terraform plan -input=false
      args:
        chdir: "{{ tf_dir }}"

    - name: Terraform apply
      ansible.builtin.command: >
        terraform apply -input=false -auto-approve
      args:
        chdir: "{{ tf_dir }}"
