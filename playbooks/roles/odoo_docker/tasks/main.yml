- name: Make sure necessary packages are installed
  apt:
    name: "{{ item }}"
    state: latest
    update_cache: yes
  loop:
    - libxdamage1
    - libgbm1
    - libxkbcommon0
    - pip

- name: Install the docker launcher from pip
  pip:
    name:
      - "{{ docker_launcher }}"
    state: latest
    break_system_packages: true

- name: Clone repo to temporary location
  ansible.builtin.git:
    repo: https://github.com/doovate-beta/dv-odoo-docker.git
    dest: /tmp/docker_repo_tmp
    depth: 1
    version: main
    force: yes
  register: git_updated

- name: Sync files to production directory
  ansible.builtin.synchronize:
    src: /tmp/docker_repo_tmp/
    dest: "{{ odoo_path }}"
    delete: no
    recursive: yes
  delegate_to: "{{ inventory_hostname }}"
  when: git_updated.changed
  register: git_output
  notify: relaunch containers

- name: Create the necessary directories for the Odoo docker containers
  file:
    path: "{{ odoo_path }}/{{ item }}"
    state: directory
    mode: '0777'
  loop:
    - addons
    - cache

- name: Create the necessary files for the Odoo docker containers
  copy:
    content: ""
    dest: "{{ odoo_path }}/{{ item }}"
    force: no
    mode: '0755'
  loop:
    - cache/addons_cache.json
    - addons/requirements.txt

- name: Create .env file from template
  template:
    src: odoo.env.j2
    dest: "{{ odoo_path }}/.env"
    mode: '0644'
  register: env_file
  notify: relaunch containers

# Todo: figure out proper permissions for these directories
- name: Set 777 permissions recursively on Odoo writable directories
  file:
    path: "{{ odoo_path }}/{{ item }}"
    mode: '0777'
    recurse: yes
  loop:
    - addons
    - cache
    - config

- name: Configure containers to use available resources
  command:
    chdir: "{{ odoo_path }}"
    cmd: "{{ docker_launcher }} config auto-config"
  when: git_output.changed or env_file.changed
  ignore_errors: yes

- name: Get selected addons from NetBox (repo_list)
  set_fact:
    selected_addon_names: "{{ custom_fields.repo_list | default([]) }}"
    temp_addons_dir: "/tmp/odoo_addons_{{ inventory_hostname }}"

- name: Show selected addons
  debug:
    msg: "Selected addons from repo_list: {{ selected_addon_names }}"

- name: Create temporary directory for addon cloning
  ansible.builtin.file:
    path: "{{ temp_addons_dir }}"
    state: directory
    mode: '0755'

- name: Clone addon repositories to temp
  ansible.builtin.git:
    repo: "{{ odoo_addon_repository_map[item].url }}"
    dest: "{{ temp_addons_dir }}/{{ item }}"
    version: "{{ odoo_addon_repository_map[item].branch }}"
    depth: 1
    force: yes
  loop: "{{ selected_addon_names }}"
  when:
    - selected_addon_names | length > 0
    - item in odoo_addon_repository_map
  register: git_clone_results

- name: Create extra addons directory
  file:
    path: "{{ odoo_path }}/addons"
    state: directory
    mode: '0777'

- name: Copy addons content from temp to final location (only if updated)
  ansible.posix.synchronize:
    src: "{{ temp_addons_dir }}/{{ item.item }}/"
    dest: "{{ odoo_path }}/addons/"
    delete: no
    recursive: yes
  loop: "{{ git_clone_results.results }}"
  loop_control:
    label: "{{ item.item }}"
  delegate_to: "{{ inventory_hostname }}"
  when:
    - item.changed | default(false)
    - not item.skipped | default(false)
  notify: relaunch containers
  no_log: "{{ not (item.changed | default(false)) }}"

- name: Find all requirements.txt files in cloned addons
  ansible.builtin.find:
    paths: "{{ temp_addons_dir }}/{{ item }}"
    patterns: "requirements.txt"
    recurse: yes
  loop: "{{ selected_addon_names }}"
  register: requirements_files
  when:
    - selected_addon_names | length > 0
    - item in odoo_addon_repository_map

- name: Flatten requirements files list
  set_fact:
    all_requirements_files: >-
      {{
        requirements_files.results |
        selectattr('files', 'defined') |
        map(attribute='files') |
        flatten |
        list
      }}
  when: requirements_files.results is defined

- name: Read all requirements.txt files
  ansible.builtin.slurp:
    src: "{{ item.path }}"
  loop: "{{ all_requirements_files }}"
  register: requirements_contents
  when: all_requirements_files | length > 0

- name: Combine all requirements into a single list
  set_fact:
    combined_requirements: >-
      {{
        requirements_contents.results |
        map(attribute='content') |
        map('b64decode') |
        map('split', '\n') |
        flatten |
        map('trim') |
        select('match', '^[^#].*') |
        select('length') |
        unique |
        sort |
        list
      }}
  when:
    - requirements_contents is defined
    - requirements_contents.results is defined

- name: Create combined requirements.txt
  ansible.builtin.copy:
    content: "{{ combined_requirements | join('\n') }}\n"
    dest: "{{ odoo_path }}/addons/requirements.txt"
    mode: '0644'
  when:
    - combined_requirements is defined
    - combined_requirements | length > 0
  notify: relaunch containers

- name: Obtain container info
  community.docker.docker_container_info:
    name: "{{ compose_project_name }}_{{ item }}"
  loop:
    - db
    - odoo
  register: container_info
  ignore_errors: yes

- name: Check if any container is down or missing
  ansible.builtin.set_fact:
    containers_stopped: true
  when: >
    (container_info.results | selectattr('exists', 'equalto', false) | list | length > 0)
    or
    (container_info.results | selectattr('exists', 'equalto', true) | selectattr('container.State.Running', 'equalto', false) | list | length > 0)

- name: Notify to relaunch if needed
  debug:
    msg: "Containers need to be relaunched"
  when: containers_stopped | default(false)
  changed_when: containers_stopped | default(false)
  notify: relaunch containers
