- hosts: traefik
  become: true
  tasks:

    - name: Make sure necessary packages are installed
      apt:
        name: "{{ item }}"
        state: latest
        update_cache: yes
      loop:
        - pip

    - name: Install required Python packages
      pip:
        name: docker
        state: present

    - name: Ensure traefik external network exists
      community.docker.docker_network:
        name: traefik

    - name: Clone repo to temporary location
      ansible.builtin.git:
        repo: https://github.com/doovate-beta/dv-traefik-docker.git
        dest: /tmp/docker_repo_tmp
        version: main
        force: yes
      register: git_updated

    - name: Sync files to traefik directory
      ansible.builtin.synchronize:
        src: /tmp/docker_repo_tmp/
        dest: /opt/traefik/
        delete: no
        recursive: yes
      delegate_to: "{{ inventory_hostname }}"
      when: git_updated.changed
      register: copy_repo

    - name: Create the necessary directories for the traefik docker containers
      file:
        path: /opt/traefik/{{ item }}
        state: directory
      loop:
        - letsencrypt
        - config/dynamic

    - name: Create the necessary files for the traefik docker containers
      copy:
        content: "{}"
        dest: /opt/traefik/letsencrypt/acme.json
        force: no
        mode: '0600'

    - name: Restart the traefik container
      shell:
        cmd: docker compose down && docker compose up -d
        chdir: /opt/traefik/
      when: copy_repo.changed


# ðŸ†• NUEVO BLOQUE: generar y copiar los dynamic.yml
- name: Generate and copy Traefik dynamic configs for Odoo hosts
  hosts: localhost
  gather_facts: no
  vars:
    local_dynamic_dir: "./generated_dynamic"
    traefik_host: "{{ groups['traefik'] | first }}"

  tasks:

    - name: Ensure local directory for dynamic configs exists
      file:
        path: "{{ local_dynamic_dir }}"
        state: directory
        mode: '0755'

    - name: Generate dynamic.yml files locally for each Odoo host
      template:
        src: ../templates/dynamic.yml.j2
        dest: "{{ local_dynamic_dir }}/{{ odoo_host_clean }}.yml"
      loop: "{{ groups['odoo'] }}"
      loop_control:
        loop_var: odoo_host
      vars:
        odoo_host_clean: "{{ odoo_host | regex_replace('[^a-zA-Z0-9._-]', '_') }}"
        ansible_host: "{{ hostvars[odoo_host]['ansible_host'] }}"
        compose_project_name: "{{ hostvars[odoo_host]['compose_project_name'] }}"
        domain: "{{ hostvars[odoo_host]['domain'] }}"
        odoo_exposed_port: "{{ hostvars[odoo_host]['odoo_exposed_port'] }}"

    - name: Copy generated dynamic configs to Traefik server
      ansible.builtin.copy:
        src: "{{ local_dynamic_dir }}/"
        dest: /opt/traefik/config/dynamic/
        mode: '0644'
      delegate_to: "{{ traefik_host }}"
      become: true
